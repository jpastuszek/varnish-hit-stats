#!/usr/bin/ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'parser'
require 'hit_stats'
require 'response_time_stats'
require 'yaml'
require 'shell_script'

$script = ShellScript.new do
	description 'Generate statistics from Varnish ammended NCSA log file'
	stdin :log_file, :description => 'Varnish ammended NCSA log file'
end
$options = $script.parse!

stats = {}

first_entry_time = nil
last_entry_time = nil

last = nil

hit_stats = HitStats.new
response_time_stats = ResponseTimeStats.new

parser_stats = UniversalAccessLogParser.varnish.parse_io($options.stdin).each do |entry|
	first_entry_time ||= entry.time
	last = entry

	hit_stats.process(entry)
	response_time_stats.process(entry)
end

last_entry_time = last.time if last

stats[:info] = {:first_entry_time => first_entry_time, :last_entry_time => last_entry_time}
stats[:parser] = {:successes => parser_stats.successes, :failures => parser_stats.failures}

if parser_stats.successes > 0
	stats[:hit] = hit_stats.to_hash
	stats[:response_time] = response_time_stats.to_hash
end

puts stats.to_yaml

