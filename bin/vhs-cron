#!/usr/bin/ruby
require 'pathname'
require 'active_support/core_ext'

jekyll_dir = Pathname.new("/var/lib/vhs/jekyll")
data_dir = Pathname.new("/var/lib/vhs/data")
site_dir = Pathname.new("/srv/http/stats")

jekyll_dir.mkpath unless jekyll_dir.directory?
data_dir.mkpath unless data_dir.directory?
site_dir.mkpath unless site_dir.directory?

data_file = "#{data_dir}/#{Time.now.yesterday.strftime('%Y-%m-%d')}.yml" 

system("cat /var/log/varnish/varnishncsa.log.1 | vhs-process > '#{data_file}'")
system("cat '#{data_file}' | vhs-generate-posts '#{jekyll_dir}'")
system("vhs-publish '#{jekyll_dir}' '#{site_dir}'")

